#!/usr/bin/env node
var Yt=Object.defineProperty;var T=(t,n)=>{for(var e in n)Yt(t,e,{get:n[e],enumerable:!0})};import qe from"node:os";import{mkdir as We}from"node:fs/promises";import Ze from"node:url";import Ge from"node:path";import{spawnSync as V}from"node:child_process";var Xt={_useHtmlParser2:!1};function P(t,n){if(!t)return n??Xt;let e={_useHtmlParser2:!!t.xmlMode,...n,...t};return t.xml?(e._useHtmlParser2=!0,e.xmlMode=!0,t.xml!==!0&&Object.assign(e,t.xml)):t.xmlMode&&(e._useHtmlParser2=!0),e}var Q={};T(Q,{contains:()=>Z,extract:()=>en,html:()=>Kt,merge:()=>gt,parseHTML:()=>tn,root:()=>nn,text:()=>j,xml:()=>Qt});import{textContent as Jt}from"domutils";function mt(t,n,e){return t?t(n??t._root.children,null,void 0,e).toString():""}function Vt(t,n){return!n&&typeof t=="object"&&t!=null&&!("length"in t)&&!("type"in t)}function Kt(t,n){let e=Vt(t)?(n=t,void 0):t,r={...this===null||this===void 0?void 0:this._options,...P(n)};return mt(this,e,r)}function Qt(t){let n={...this._options,xmlMode:!0};return mt(this,t,n)}function j(t){let n=t??(this?this.root():[]),e="";for(let r=0;r<n.length;r++)e+=Jt(n[r]);return e}function tn(t,n,e=typeof n=="boolean"?n:!1){if(!t||typeof t!="string")return null;typeof n=="boolean"&&(e=n);let r=this.load(t,this._options,!1);return e||r("script").remove(),[...r.root()[0].children]}function nn(){return this(this._root)}function Z(t,n){if(n===t)return!1;let e=n;for(;e&&e!==e.parent;)if(e=e.parent,e===t)return!0;return!1}function en(t){return this.root().extract(t)}function gt(t,n){if(!dt(t)||!dt(n))return;let e=t.length,r=+n.length;for(let i=0;i<r;i++)t[e++]=n[i];return t.length=e,t}function dt(t){if(Array.isArray(t))return!0;if(typeof t!="object"||t===null||!("length"in t)||typeof t.length!="number"||t.length<0)return!1;for(let n=0;n<t.length;n++)if(!(n in t))return!1;return!0}var rt={};T(rt,{addClass:()=>kt,attr:()=>cn,data:()=>ln,hasClass:()=>dn,prop:()=>an,removeAttr:()=>pn,removeClass:()=>wt,toggleClass:()=>$t,val:()=>hn});function x(t){return t.cheerio!=null}function xt(t){return t.replace(/[._-](\w|$)/g,(n,e)=>e.toUpperCase())}function yt(t){return t.replace(/[A-Z]/g,"-$&").toLowerCase()}function p(t,n){let e=t.length;for(let r=0;r<e;r++)n(t[r],r);return t}var E;(function(t){t[t.LowerA=97]="LowerA",t[t.LowerZ=122]="LowerZ",t[t.UpperA=65]="UpperA",t[t.UpperZ=90]="UpperZ",t[t.Exclamation=33]="Exclamation"})(E||(E={}));function R(t){let n=t.indexOf("<");if(n<0||n>t.length-3)return!1;let e=t.charCodeAt(n+1);return(e>=E.LowerA&&e<=E.LowerZ||e>=E.UpperA&&e<=E.UpperZ||e===E.Exclamation)&&t.includes(">",n+2)}import{isTag as d}from"domhandler";import{innerText as rn,textContent as on}from"domutils";var U=Object.prototype.hasOwnProperty,I=/\s+/,nt="data-",et=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,sn=/^{[^]*}$|^\[[^]*]$/;function G(t,n,e){var r;if(!(!t||!d(t))){if((r=t.attribs)!==null&&r!==void 0||(t.attribs={}),!n)return t.attribs;if(U.call(t.attribs,n))return!e&&et.test(n)?n:t.attribs[n];if(t.name==="option"&&n==="value")return j(t.children);if(t.name==="input"&&(t.attribs.type==="radio"||t.attribs.type==="checkbox")&&n==="value")return"on"}}function M(t,n,e){e===null?vt(t,n):t.attribs[n]=`${e}`}function cn(t,n){if(typeof t=="object"||n!==void 0){if(typeof n=="function"){if(typeof t!="string")throw new Error("Bad combination of arguments.");return p(this,(e,r)=>{d(e)&&M(e,t,n.call(e,r,e.attribs[t]))})}return p(this,e=>{if(d(e))if(typeof t=="object")for(let r of Object.keys(t)){let i=t[r];M(e,r,i)}else M(e,t,n)})}return arguments.length>1?this:G(this[0],t,this.options.xmlMode)}function _t(t,n,e){return n in t?t[n]:!e&&et.test(n)?G(t,n,!1)!==void 0:G(t,n,e)}function tt(t,n,e,r){n in t?t[n]=e:M(t,n,!r&&et.test(n)?e?"":null:`${e}`)}function an(t,n){var e;if(typeof t=="string"&&n===void 0){let r=this[0];if(!r||!d(r))return;switch(t){case"style":{let i=this.css(),o=Object.keys(i);for(let s=0;s<o.length;s++)i[s]=o[s];return i.length=o.length,i}case"tagName":case"nodeName":return r.name.toUpperCase();case"href":case"src":{let i=(e=r.attribs)===null||e===void 0?void 0:e[t];return typeof URL<"u"&&(t==="href"&&(r.tagName==="a"||r.tagName==="link")||t==="src"&&(r.tagName==="img"||r.tagName==="iframe"||r.tagName==="audio"||r.tagName==="video"||r.tagName==="source"))&&i!==void 0&&this.options.baseURI?new URL(i,this.options.baseURI).href:i}case"innerText":return rn(r);case"textContent":return on(r);case"outerHTML":return this.clone().wrap("<container />").parent().html();case"innerHTML":return this.html();default:return _t(r,t,this.options.xmlMode)}}if(typeof t=="object"||n!==void 0){if(typeof n=="function"){if(typeof t=="object")throw new TypeError("Bad combination of arguments.");return p(this,(r,i)=>{d(r)&&tt(r,t,n.call(r,i,_t(r,t,this.options.xmlMode)),this.options.xmlMode)})}return p(this,r=>{if(d(r))if(typeof t=="object")for(let i of Object.keys(t)){let o=t[i];tt(r,i,o,this.options.xmlMode)}else tt(r,t,n,this.options.xmlMode)})}}function bt(t,n,e){var r;(r=t.data)!==null&&r!==void 0||(t.data={}),typeof n=="object"?Object.assign(t.data,n):typeof n=="string"&&e!==void 0&&(t.data[n]=e)}function fn(t){for(let n of Object.keys(t.attribs)){if(!n.startsWith(nt))continue;let e=xt(n.slice(nt.length));U.call(t.data,e)||(t.data[e]=At(t.attribs[n]))}return t.data}function un(t,n){let e=nt+yt(n),r=t.data;if(U.call(r,n))return r[n];if(U.call(t.attribs,e))return r[n]=At(t.attribs[e])}function At(t){if(t==="null")return null;if(t==="true")return!0;if(t==="false")return!1;let n=Number(t);if(t===String(n))return n;if(sn.test(t))try{return JSON.parse(t)}catch{}return t}function ln(t,n){var e;let r=this[0];if(!r||!d(r))return;let i=r;return(e=i.data)!==null&&e!==void 0||(i.data={}),t==null?fn(i):typeof t=="object"||n!==void 0?(p(this,o=>{d(o)&&(typeof t=="object"?bt(o,t):bt(o,t,n))}),this):un(i,t)}function hn(t){let n=arguments.length===0,e=this[0];if(!e||!d(e))return n?void 0:this;switch(e.name){case"textarea":return this.text(t);case"select":{let r=this.find("option:selected");if(!n){if(this.attr("multiple")==null&&typeof t=="object")return this;this.find("option").removeAttr("selected");let i=typeof t=="object"?t:[t];for(let o of i)this.find(`option[value="${o}"]`).attr("selected","");return this}return this.attr("multiple")?r.toArray().map(i=>j(i.children)):r.attr("value")}case"input":case"option":return n?this.attr("value"):this.attr("value",t)}}function vt(t,n){!t.attribs||!U.call(t.attribs,n)||delete t.attribs[n]}function Y(t){return t?t.trim().split(I):[]}function pn(t){let n=Y(t);for(let e of n)p(this,r=>{d(r)&&vt(r,e)});return this}function dn(t){return this.toArray().some(n=>{let e=d(n)&&n.attribs.class,r=-1;if(e&&t.length>0)for(;(r=e.indexOf(t,r+1))>-1;){let i=r+t.length;if((r===0||I.test(e[r-1]))&&(i===e.length||I.test(e[i])))return!0}return!1})}function kt(t){if(typeof t=="function")return p(this,(r,i)=>{if(d(r)){let o=r.attribs.class||"";kt.call([r],t.call(r,i,o))}});if(!t||typeof t!="string")return this;let n=t.split(I),e=this.length;for(let r=0;r<e;r++){let i=this[r];if(!d(i))continue;let o=G(i,"class",!1);if(o){let s=` ${o} `;for(let c of n){let a=`${c} `;s.includes(` ${a}`)||(s+=a)}M(i,"class",s.trim())}else M(i,"class",n.join(" ").trim())}return this}function wt(t){if(typeof t=="function")return p(this,(i,o)=>{d(i)&&wt.call([i],t.call(i,o,i.attribs.class||""))});let n=Y(t),e=n.length,r=arguments.length===0;return p(this,i=>{if(d(i))if(r)i.attribs.class="";else{let o=Y(i.attribs.class),s=!1;for(let c=0;c<e;c++){let a=o.indexOf(n[c]);a>=0&&(o.splice(a,1),s=!0,c--)}s&&(i.attribs.class=o.join(" "))}})}function $t(t,n){if(typeof t=="function")return p(this,(s,c)=>{d(s)&&$t.call([s],t.call(s,c,s.attribs.class||"",n),n)});if(!t||typeof t!="string")return this;let e=t.split(I),r=e.length,i=typeof n=="boolean"?n?1:-1:0,o=this.length;for(let s=0;s<o;s++){let c=this[s];if(!d(c))continue;let a=Y(c.attribs.class);for(let l=0;l<r;l++){let f=a.indexOf(e[l]);i>=0&&f<0?a.push(e[l]):i<=0&&f>=0&&a.splice(f,1)}c.attribs.class=a.join(" ")}return this}var at={};T(at,{_findBySelector:()=>bn,add:()=>Yn,addBack:()=>Xn,children:()=>On,closest:()=>wn,contents:()=>Dn,each:()=>Pn,end:()=>Gn,eq:()=>Hn,filter:()=>Cn,filterArray:()=>ct,find:()=>_n,first:()=>Bn,get:()=>Fn,has:()=>In,index:()=>Wn,is:()=>Rn,last:()=>zn,map:()=>Mn,next:()=>$n,nextAll:()=>Sn,nextUntil:()=>Ln,not:()=>Un,parent:()=>An,parents:()=>vn,parentsUntil:()=>kn,prev:()=>Tn,prevAll:()=>jn,prevUntil:()=>En,siblings:()=>Nn,slice:()=>Zn,toArray:()=>qn});import{isTag as N,hasChildren as mn,isDocument as X}from"domhandler";import*as y from"cheerio-select";import{getChildren as gn,getSiblings as xn,nextElementSibling as St,prevElementSibling as Lt,uniqueSort as J}from"domutils";var yn=/^\s*[+~]/;function _n(t){if(!t)return this._make([]);if(typeof t!="string"){let n=x(t)?t.toArray():[t],e=this.toArray();return this._make(n.filter(r=>e.some(i=>Z(i,r))))}return this._findBySelector(t,Number.POSITIVE_INFINITY)}function bn(t,n){var e;let r=this.toArray(),i=yn.test(t)?r:this.children().toArray(),o={context:r,root:(e=this._root)===null||e===void 0?void 0:e[0],xmlMode:this.options.xmlMode,lowerCaseTags:this.options.lowerCaseTags,lowerCaseAttributeNames:this.options.lowerCaseAttributeNames,pseudos:this.options.pseudos,quirksMode:this.options.quirksMode};return this._make(y.select(t,i,o,n))}function it(t){return function(n,...e){return function(r){var i;let o=t(n,this);return r&&(o=ct(o,r,this.options.xmlMode,(i=this._root)===null||i===void 0?void 0:i[0])),this._make(this.length>1&&o.length>1?e.reduce((s,c)=>c(s),o):o)}}}var B=it((t,n)=>{let e=[];for(let r=0;r<n.length;r++){let i=t(n[r]);i.length>0&&(e=e.concat(i))}return e}),ot=it((t,n)=>{let e=[];for(let r=0;r<n.length;r++){let i=t(n[r]);i!==null&&e.push(i)}return e});function st(t,...n){let e=null,r=it((i,o)=>{let s=[];return p(o,c=>{for(let a;(a=i(c))&&!e?.(a,s.length);c=a)s.push(a)}),s})(t,...n);return function(i,o){e=typeof i=="string"?c=>y.is(c,i,this.options):i?z(i):null;let s=r.call(this,o);return e=null,s}}function C(t){return t.length>1?Array.from(new Set(t)):t}var An=ot(({parent:t})=>t&&!X(t)?t:null,C),vn=B(t=>{let n=[];for(;t.parent&&!X(t.parent);)n.push(t.parent),t=t.parent;return n},J,t=>t.reverse()),kn=st(({parent:t})=>t&&!X(t)?t:null,J,t=>t.reverse());function wn(t){var n;let e=[];if(!t)return this._make(e);let r={xmlMode:this.options.xmlMode,root:(n=this._root)===null||n===void 0?void 0:n[0]},i=typeof t=="string"?o=>y.is(o,t,r):z(t);return p(this,o=>{for(o&&!X(o)&&!N(o)&&(o=o.parent);o&&N(o);){if(i(o,0)){e.includes(o)||e.push(o);break}o=o.parent}}),this._make(e)}var $n=ot(t=>St(t)),Sn=B(t=>{let n=[];for(;t.next;)t=t.next,N(t)&&n.push(t);return n},C),Ln=st(t=>St(t),C),Tn=ot(t=>Lt(t)),jn=B(t=>{let n=[];for(;t.prev;)t=t.prev,N(t)&&n.push(t);return n},C),En=st(t=>Lt(t),C),Nn=B(t=>xn(t).filter(n=>N(n)&&n!==t),J),On=B(t=>gn(t).filter(N),C);function Dn(){let t=this.toArray().reduce((n,e)=>mn(e)?n.concat(e.children):n,[]);return this._make(t)}function Pn(t){let n=0,e=this.length;for(;n<e&&t.call(this[n],n,this[n])!==!1;)++n;return this}function Mn(t){let n=[];for(let e=0;e<this.length;e++){let r=this[e],i=t.call(r,e,r);i!=null&&(n=n.concat(i))}return this._make(n)}function z(t){return typeof t=="function"?(n,e)=>t.call(n,e,n):x(t)?n=>Array.prototype.includes.call(t,n):function(n){return t===n}}function Cn(t){var n;return this._make(ct(this.toArray(),t,this.options.xmlMode,(n=this._root)===null||n===void 0?void 0:n[0]))}function ct(t,n,e,r){return typeof n=="string"?y.filter(n,t,{xmlMode:e,root:r}):t.filter(z(n))}function Rn(t){let n=this.toArray();return typeof t=="string"?y.some(n.filter(N),t,this.options):t?n.some(z(t)):!1}function Un(t){let n=this.toArray();if(typeof t=="string"){let e=new Set(y.filter(t,n,this.options));n=n.filter(r=>!e.has(r))}else{let e=z(t);n=n.filter((r,i)=>!e(r,i))}return this._make(n)}function In(t){return this.filter(typeof t=="string"?`:has(${t})`:(n,e)=>this._make(e).find(t).length>0)}function Bn(){return this.length>1?this._make(this[0]):this}function zn(){return this.length>0?this._make(this[this.length-1]):this}function Hn(t){var n;return t=+t,t===0&&this.length<=1?this:(t<0&&(t=this.length+t),this._make((n=this[t])!==null&&n!==void 0?n:[]))}function Fn(t){return t==null?this.toArray():this[t<0?this.length+t:t]}function qn(){return Array.prototype.slice.call(this)}function Wn(t){let n,e;return t==null?(n=this.parent().children(),e=this[0]):typeof t=="string"?(n=this._make(t),e=this[0]):(n=this,e=x(t)?t[0]:t),Array.prototype.indexOf.call(n,e)}function Zn(t,n){return this._make(Array.prototype.slice.call(this,t,n))}function Gn(){var t;return(t=this.prevObject)!==null&&t!==void 0?t:this._make([])}function Yn(t,n){let e=this._make(t,n),r=J([...this.get(),...e.get()]);return this._make(r)}function Xn(t){return this.prevObject?this.add(t?this.prevObject.filter(t):this.prevObject):this}var ut={};T(ut,{_makeDomArray:()=>re,after:()=>he,append:()=>se,appendTo:()=>ie,before:()=>de,clone:()=>ve,empty:()=>ye,html:()=>_e,insertAfter:()=>pe,insertBefore:()=>me,prepend:()=>ce,prependTo:()=>oe,remove:()=>ge,replaceWith:()=>xe,text:()=>Ae,toString:()=>be,unwrap:()=>ue,wrap:()=>ae,wrapAll:()=>le,wrapInner:()=>fe});import{isTag as Qn,Text as te,hasChildren as b,cloneNode as ft,Document as ne}from"domhandler";import{removeElement as Jn}from"domutils";import{Document as Vn,isDocument as Kn}from"domhandler";function Tt(t){return function(e,r,i,o){if(typeof Buffer<"u"&&Buffer.isBuffer(e)&&(e=e.toString()),typeof e=="string")return t(e,r,i,o);let s=e;if(!Array.isArray(s)&&Kn(s))return s;let c=new Vn([]);return w(s,c),c}}function w(t,n){let e=Array.isArray(t)?t:[t];n?n.children=e:n=null;for(let r=0;r<e.length;r++){let i=e[r];i.parent&&i.parent.children!==e&&Jn(i),n?(i.prev=e[r-1]||null,i.next=e[r+1]||null):i.prev=i.next=null,i.parent=n}return n}import{removeElement as ee}from"domutils";function re(t,n){if(t==null)return[];if(typeof t=="string")return this._parse(t,this.options,!1,null).children.slice(0);if("length"in t){if(t.length===1)return this._makeDomArray(t[0],n);let e=[];for(let r=0;r<t.length;r++){let i=t[r];if(typeof i=="object"){if(i==null)continue;if(!("length"in i)){e.push(n?ft(i,!0):i);continue}}e.push(...this._makeDomArray(i,n))}return e}return[n?ft(t,!0):t]}function jt(t){return function(...n){let e=this.length-1;return p(this,(r,i)=>{if(!b(r))return;let o=typeof n[0]=="function"?n[0].call(r,i,this._render(r.children)):n,s=this._makeDomArray(o,i<e);t(s,r.children,r)})}}function $(t,n,e,r,i){var o,s;let c=[n,e,...r],a=n===0?null:t[n-1],l=n+e>=t.length?null:t[n+e];for(let f=0;f<r.length;++f){let u=r[f],m=u.parent;if(m){let g=m.children.indexOf(u);g>-1&&(m.children.splice(g,1),i===m&&n>g&&c[0]--)}u.parent=i,u.prev&&(u.prev.next=(o=u.next)!==null&&o!==void 0?o:null),u.next&&(u.next.prev=(s=u.prev)!==null&&s!==void 0?s:null),u.prev=f===0?a:r[f-1],u.next=f===r.length-1?l:r[f+1]}return a&&(a.next=r[0]),l&&(l.prev=r[r.length-1]),t.splice(...c)}function ie(t){return(x(t)?t:this._make(t)).append(this),this}function oe(t){return(x(t)?t:this._make(t)).prepend(this),this}var se=jt((t,n,e)=>{$(n,n.length,0,t,e)}),ce=jt((t,n,e)=>{$(n,0,0,t,e)});function Et(t){return function(n){let e=this.length-1,r=this.parents().last();for(let i=0;i<this.length;i++){let o=this[i],s=typeof n=="function"?n.call(o,i,o):typeof n=="string"&&!R(n)?r.find(n).clone():n,[c]=this._makeDomArray(s,i<e);if(!c||!b(c))continue;let a=c,l=0;for(;l<a.children.length;){let f=a.children[l];Qn(f)?(a=f,l=0):l++}t(o,a,[c])}return this}}var ae=Et((t,n,e)=>{let{parent:r}=t;if(!r)return;let i=r.children,o=i.indexOf(t);w([t],n),$(i,o,0,e,r)}),fe=Et((t,n,e)=>{b(t)&&(w(t.children,n),w(e,t))});function ue(t){return this.parent(t).not("body").each((n,e)=>{this._make(e).replaceWith(e.children)}),this}function le(t){let n=this[0];if(n){let e=this._make(typeof t=="function"?t.call(n,0,n):t).insertBefore(n),r;for(let o=0;o<e.length;o++)e[o].type==="tag"&&(r=e[o]);let i=0;for(;r&&i<r.children.length;){let o=r.children[i];o.type==="tag"?(r=o,i=0):i++}r&&this._make(r).append(this)}return this}function he(...t){let n=this.length-1;return p(this,(e,r)=>{if(!b(e)||!e.parent)return;let i=e.parent.children,o=i.indexOf(e);if(o<0)return;let s=typeof t[0]=="function"?t[0].call(e,r,this._render(e.children)):t,c=this._makeDomArray(s,r<n);$(i,o+1,0,c,e.parent)})}function pe(t){typeof t=="string"&&(t=this._make(t)),this.remove();let n=[];for(let e of this._makeDomArray(t)){let r=this.clone().toArray(),{parent:i}=e;if(!i)continue;let o=i.children,s=o.indexOf(e);s<0||($(o,s+1,0,r,i),n.push(...r))}return this._make(n)}function de(...t){let n=this.length-1;return p(this,(e,r)=>{if(!b(e)||!e.parent)return;let i=e.parent.children,o=i.indexOf(e);if(o<0)return;let s=typeof t[0]=="function"?t[0].call(e,r,this._render(e.children)):t,c=this._makeDomArray(s,r<n);$(i,o,0,c,e.parent)})}function me(t){let n=this._make(t);this.remove();let e=[];return p(n,r=>{let i=this.clone().toArray(),{parent:o}=r;if(!o)return;let s=o.children,c=s.indexOf(r);c<0||($(s,c,0,i,o),e.push(...i))}),this._make(e)}function ge(t){let n=t?this.filter(t):this;return p(n,e=>{ee(e),e.prev=e.next=e.parent=null}),this}function xe(t){return p(this,(n,e)=>{let{parent:r}=n;if(!r)return;let i=r.children,o=typeof t=="function"?t.call(n,e,n):t,s=this._makeDomArray(o);w(s,null);let c=i.indexOf(n);$(i,c,1,s,r),s.includes(n)||(n.parent=n.prev=n.next=null)})}function ye(){return p(this,t=>{if(b(t)){for(let n of t.children)n.next=n.prev=n.parent=null;t.children.length=0}})}function _e(t){if(t===void 0){let n=this[0];return!n||!b(n)?null:this._render(n.children)}return p(this,n=>{if(!b(n))return;for(let r of n.children)r.next=r.prev=r.parent=null;let e=x(t)?t.toArray():this._parse(`${t}`,this.options,!1,n).children;w(e,n)})}function be(){return this._render(this)}function Ae(t){return t===void 0?j(this):typeof t=="function"?p(this,(n,e)=>this._make(n).text(t.call(n,e,j([n])))):p(this,n=>{if(!b(n))return;for(let r of n.children)r.next=r.prev=r.parent=null;let e=new te(`${t}`);w(e,n)})}function ve(){let t=Array.prototype.map.call(this.get(),e=>ft(e,!0)),n=new ne(t);for(let e of t)e.parent=n;return this._make(t)}var lt={};T(lt,{css:()=>ke});import{isTag as Nt}from"domhandler";function ke(t,n){if(t!=null&&n!=null||typeof t=="object"&&!Array.isArray(t))return p(this,(e,r)=>{Nt(e)&&Ot(e,t,n,r)});if(this.length!==0)return Dt(this[0],t)}function Ot(t,n,e,r){if(typeof n=="string"){let i=Dt(t),o=typeof e=="function"?e.call(t,r,i[n]):e;o===""?delete i[n]:o!=null&&(i[n]=o),t.attribs.style=we(i)}else if(typeof n=="object"){let i=Object.keys(n);for(let o=0;o<i.length;o++){let s=i[o];Ot(t,s,n[s],o)}}}function Dt(t,n){if(!t||!Nt(t))return;let e=$e(t.attribs.style);if(typeof n=="string")return e[n];if(Array.isArray(n)){let r={};for(let i of n)e[i]!=null&&(r[i]=e[i]);return r}return e}function we(t){return Object.keys(t).reduce((n,e)=>`${n}${n?" ":""}${e}: ${t[e]};`,"")}function $e(t){if(t=(t||"").trim(),!t)return{};let n={},e;for(let r of t.split(";")){let i=r.indexOf(":");if(i<1||i===r.length-1){let o=r.trimEnd();o.length>0&&e!==void 0&&(n[e]+=`;${o}`)}else e=r.slice(0,i).trim(),n[e]=r.slice(i+1).trim()}return n}var ht={};T(ht,{serialize:()=>Te,serializeArray:()=>je});import{isTag as Se}from"domhandler";var Pt="input,select,textarea,keygen",Le=/%20/g,Mt=/\r?\n/g;function Te(){return this.serializeArray().map(e=>`${encodeURIComponent(e.name)}=${encodeURIComponent(e.value)}`).join("&").replace(Le,"+")}function je(){return this.map((t,n)=>{let e=this._make(n);return Se(n)&&n.name==="form"?e.find(Pt).toArray():e.filter(Pt).toArray()}).filter('[name!=""]:enabled:not(:submit, :button, :image, :reset, :file):matches([checked], :not(:checkbox, :radio))').map((t,n)=>{var e;let r=this._make(n),i=r.attr("name"),o=(e=r.val())!==null&&e!==void 0?e:"";return Array.isArray(o)?o.map(s=>({name:i,value:s.replace(Mt,`\r
`)})):{name:i,value:o.replace(Mt,`\r
`)}}).toArray()}var pt={};T(pt,{extract:()=>Ne});function Ee(t){var n;return typeof t=="string"?{selector:t,value:"textContent"}:{selector:t.selector,value:(n=t.value)!==null&&n!==void 0?n:"textContent"}}function Ne(t){let n={};for(let e in t){let r=t[e],i=Array.isArray(r),{selector:o,value:s}=Ee(i?r[0]:r),c=typeof s=="function"?s:typeof s=="string"?a=>this._make(a).prop(s):a=>this._make(a).extract(s);if(i)n[e]=this._findBySelector(o,Number.POSITIVE_INFINITY).map((a,l)=>c(l,e,n)).get();else{let a=this._findBySelector(o,1);n[e]=a.length>0?c(a[0],e,n):void 0}}return n}var S=class{constructor(n,e,r){if(this.length=0,this.options=r,this._root=e,n){for(let i=0;i<n.length;i++)this[i]=n[i];this.length=n.length}}};S.prototype.cheerio="[cheerio object]";S.prototype.splice=Array.prototype.splice;S.prototype[Symbol.iterator]=Array.prototype[Symbol.iterator];Object.assign(S.prototype,rt,at,ut,lt,ht,pt);function Ct(t,n){return function e(r,i,o=!0){if(r==null)throw new Error("cheerio.load() expects a string");let s=P(i),c=t(r,s,o,null);class a extends S{_make(u,m){let A=l(u,m);return A.prevObject=this,A}_parse(u,m,A,g){return t(u,m,A,g)}_render(u){return n(u,this.options)}}function l(f,u,m=c,A){if(f&&x(f))return f;let g=P(A,s),v=typeof m=="string"?[t(m,g,!1,null)]:"length"in m?m:[m],h=x(v)?v:new a(v,null,g);if(h._root=h,!f)return new a(void 0,h,g);let O=typeof f=="string"&&R(f)?t(f,g,!1,null).children:Oe(f)?[f]:Array.isArray(f)?f:void 0,D=new a(O,h,g);if(O)return D;if(typeof f!="string")throw new TypeError("Unexpected type of selector");let L=f,k=u?typeof u=="string"?R(u)?new a([t(u,g,!1,null)],h,g):(L=`${u} ${L}`,h):x(u)?u:new a(Array.isArray(u)?u:[u],h,g):h;return k?k.find(L):D}return Object.assign(l,Q,{load:e,_root:c,_options:s,fn:a.prototype,prototype:a.prototype}),l}}function Oe(t){return!!t.name||t.type==="root"||t.type==="text"||t.type==="comment"}import{isDocument as De}from"domhandler";import{parse as Pe,parseFragment as Me,serializeOuter as Ce}from"parse5";import{adapter as Rt}from"parse5-htmlparser2-tree-adapter";function Ut(t,n,e,r){var i;return(i=n.treeAdapter)!==null&&i!==void 0||(n.treeAdapter=Rt),n.scriptingEnabled!==!1&&(n.scriptingEnabled=!0),e?Pe(t,n):Me(r,t,n)}var Re={treeAdapter:Rt};function It(t){let n="length"in t?t:[t];for(let r=0;r<n.length;r+=1){let i=n[r];De(i)&&Array.prototype.splice.call(n,r,1,...i.children)}let e="";for(let r=0;r<n.length;r+=1){let i=n[r];e+=Ce(i,Re)}return e}import Ue from"dom-serializer";import{parseDocument as Ie}from"htmlparser2";var Be=Tt((t,n,e,r)=>n._useHtmlParser2?Ie(t,n):Ut(t,n,e,r)),H=Ct(Be,(t,n)=>n._useHtmlParser2?Ue(t,n):It(t));import{adapter as Ur}from"parse5-htmlparser2-tree-adapter";import*as ze from"htmlparser2";import{ParserStream as Br}from"parse5-parser-stream";import{decodeBuffer as Hr,DecodeStream as Fr}from"encoding-sniffer";import*as He from"undici";import Wr from"whatwg-mimetype";import{Writable as Gr,finished as Yr}from"node:stream";var Ye=Ge.basename(Ze.fileURLToPath(import.meta.url)),q=process.argv.slice(2).join(" "),_="https://soaper.tv",F=process.env.SOAPER_DOWNLOAD_PATH||qe.homedir(),Ft=process.env.SOAPER_SUB_LANG||"en",Xe=new Date().getFullYear();console.log("SEARCH_TERM:",q);(q==="-h"||q==="--help")&&(console.info(`Usage: ${Ye} <SEARCH TERM>`),process.exit(0));if(!q){let t=await fetch(`https://soaper.tv/movielist/year/${Xe}/sort/release`).then(i=>i.text()).then(i=>H(i)),n=[];t("div.thumbnail.text-center").each((i,o)=>{let s=t(o).find(".img-tip.label.label-info").text(),c=t(o).find("h5").text().replaceAll(" ","_"),a=t(o).find("h5 > a").attr("href");n.push(`[${s}] ${c} ${_+a}`)});let r=await qt(n,"New releases");Wt(r)}async function qt(t,n){return V(`echo "${t.join(`
`)}" | fzf --header-first --header="${n}" --cycle --with-nth 1,2,3`,{stdio:["inherit","pipe","inherit"],shell:!0,encoding:"utf-8"}).stdout.replace(/\n$/,"")}async function Je(){let t=`${_}/search.html?keyword=`,n=await fetch(t+q).then(o=>o.text()).then(o=>H(o)),e=n("div.thumbnail.text-center");e.length===0&&(console.info("[soaper-dl] Nothing found, try another search term"),process.exit(0));let r=[];return e.each((o,s)=>{let c=n(s).find(".img-group > div").text(),a=n(s).find("h5").text().replaceAll(" ","_"),l=n(s).find("h5 > a").attr("href");r.push(`[${c}] ${a} ${_+l}`)}),await qt(r,"Search results")}async function Bt(t,n){let e=t.match(/_(?<pass>.*)\.html/)?.groups?.pass??"";if(!e)throw"[soaper-dl-error] Couldn't get passkey";let r=await fetch(`${_}/home/index/${n}`,{headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8",Referer:`${_}${t}`},body:`pass=${e}`,method:"POST"}).then(c=>c.json()),{subs:i,val:o}=r;if(o==="Cannot get video source.")throw"[soaper-dl-error] Cannot get video source.";let s=i?.find(c=>c.name.includes(Ft));return{m3u8Link:o,subLink:s?.path?s.path:null}}async function zt(t,n="inherit"){return V(t,{stdio:["inherit",n,"inherit"],shell:!0,encoding:"utf-8"})}function Ht(t){return t.replace(/[/\\*?<>|'[\]()]/g,"")}async function Wt(t){let[n,e,r]=t.split(" "),i=t.includes("/tv_"),o=i?"GetEInfoAjax":"GetMInfoAjax";if(i){if(i){let c=function(h){return Number(h)<10?"0"+h:h};var s=c;let a=e.split("_").slice(0,-1).join("_")||"",l=`${F}/${a}`,f=await fetch(r).then(h=>h.text()).then(h=>H(h)),u=[],m=f(".alert-info-ex");for(let h of m){let O=f(h).find("h4").text(),D=/Season(\d){1,2}/.exec(O)?.[1]||"N/A",L=f(h).find("div > a");for(let k of L){let[K,W]=f(k).text().replaceAll(" ","_").split(".");u.push(`[S${c(D)}E${c(K)}] ${W} ${_+f(k).attr("href")}`)}}let g=V(`echo "${u.join(`
`)}" | fzf --header-first --header="Choose episodes to download with <TAB>" --multi --cycle --with-nth 1,2,3`,{stdio:["inherit","pipe","inherit"],shell:!0,encoding:"utf-8"}).stdout.split(`
`).sort(),v=[];try{await We(l,{recursive:!0})&&console.info(`[soaper-dl] Creating folder for series: ${F}/${a}`)}catch(h){console.error("[soaper-dl-error] Could not make a folder for series"),console.error(h.message)}for(let h of g){if(!h)continue;let[O,D,L]=h.split(" "),k=Ht(`${a}_${O}_${D}`),{m3u8Link:K,subLink:W}=await Bt(L,o);if(W){let Gt=`curl '${_+W}' --output-dir '${l}' -o ${k}.en.srt`;v.push(Gt)}let Zt=`yt-dlp --quiet '${_+K}' -P ${l} -o ${k}.mp4`;v.push(Zt)}console.log("commands:",v);for(let h of v)console.info(`[soaper-dl] Downloading ${h.split(" ").at(-1)}`),V(h,{stdio:["inherit","inherit","inherit"],shell:!0,encoding:"utf-8"})}}else{let{m3u8Link:c,subLink:a}=await Bt(r,o),l=Ht(`${e}_${n}`);a&&(console.info(`[soaper-dl] Downloading subtitles ${l}`),zt(`curl ${_+a} --output-dir '${F}' -o ${l}.${Ft}.srt`)),console.info(`[soaper-dl] Downloading ${F}/${l}`),zt(`yt-dlp '${_+c}' -P ${F} -o ${l}.mp4`)}}async function Ve(){let t=await Je().catch(n=>{console.error("[soaper-dl-error] Search fetch failed"),console.error(n),process.exit(1)});t||process.exit(1),await Wt(t)}Ve().catch(t=>{console.error(t),process.exit(1)});
//# sourceMappingURL=soaper-dl.js.map