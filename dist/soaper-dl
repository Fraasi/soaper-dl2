#!/usr/bin/env node
var Gt=Object.defineProperty;var j=(t,e)=>{for(var n in e)Gt(t,n,{get:e[n],enumerable:!0})};var Yt={_useHtmlParser2:!1};function P(t,e){if(!t)return e??Yt;let n={_useHtmlParser2:!!t.xmlMode,...e,...t};return t.xml?(n._useHtmlParser2=!0,n.xmlMode=!0,t.xml!==!0&&Object.assign(n,t.xml)):t.xmlMode&&(n._useHtmlParser2=!0),n}var V={};j(V,{contains:()=>F,extract:()=>ee,html:()=>Vt,merge:()=>gt,parseHTML:()=>Qt,root:()=>te,text:()=>T,xml:()=>Kt});import{textContent as Xt}from"domutils";function mt(t,e,n){return t?t(e??t._root.children,null,void 0,n).toString():""}function Jt(t,e){return!e&&typeof t=="object"&&t!=null&&!("length"in t)&&!("type"in t)}function Vt(t,e){let n=Jt(t)?(e=t,void 0):t,r={...this===null||this===void 0?void 0:this._options,...P(e)};return mt(this,n,r)}function Kt(t){let e={...this._options,xmlMode:!0};return mt(this,t,e)}function T(t){let e=t??(this?this.root():[]),n="";for(let r=0;r<e.length;r++)n+=Xt(e[r]);return n}function Qt(t,e,n=typeof e=="boolean"?e:!1){if(!t||typeof t!="string")return null;typeof e=="boolean"&&(n=e);let r=this.load(t,this._options,!1);return n||r("script").remove(),[...r.root()[0].children]}function te(){return this(this._root)}function F(t,e){if(e===t)return!1;let n=e;for(;n&&n!==n.parent;)if(n=n.parent,n===t)return!0;return!1}function ee(t){return this.root().extract(t)}function gt(t,e){if(!dt(t)||!dt(e))return;let n=t.length,r=+e.length;for(let i=0;i<r;i++)t[n++]=e[i];return t.length=n,t}function dt(t){if(Array.isArray(t))return!0;if(typeof t!="object"||t===null||!("length"in t)||typeof t.length!="number"||t.length<0)return!1;for(let e=0;e<t.length;e++)if(!(e in t))return!1;return!0}var et={};j(et,{addClass:()=>kt,attr:()=>oe,data:()=>fe,hasClass:()=>pe,prop:()=>se,removeAttr:()=>ue,removeClass:()=>wt,toggleClass:()=>$t,val:()=>le});function x(t){return t.cheerio!=null}function xt(t){return t.replace(/[._-](\w|$)/g,(e,n)=>n.toUpperCase())}function yt(t){return t.replace(/[A-Z]/g,"-$&").toLowerCase()}function h(t,e){let n=t.length;for(let r=0;r<n;r++)e(t[r],r);return t}var N;(function(t){t[t.LowerA=97]="LowerA",t[t.LowerZ=122]="LowerZ",t[t.UpperA=65]="UpperA",t[t.UpperZ=90]="UpperZ",t[t.Exclamation=33]="Exclamation"})(N||(N={}));function R(t){let e=t.indexOf("<");if(e<0||e>t.length-3)return!1;let n=t.charCodeAt(e+1);return(n>=N.LowerA&&n<=N.LowerZ||n>=N.UpperA&&n<=N.UpperZ||n===N.Exclamation)&&t.includes(">",e+2)}import{isTag as d}from"domhandler";import{innerText as ne,textContent as re}from"domutils";var U=Object.prototype.hasOwnProperty,I=/\s+/,Q="data-",tt=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,ie=/^{[^]*}$|^\[[^]*]$/;function W(t,e,n){var r;if(!(!t||!d(t))){if((r=t.attribs)!==null&&r!==void 0||(t.attribs={}),!e)return t.attribs;if(U.call(t.attribs,e))return!n&&tt.test(e)?e:t.attribs[e];if(t.name==="option"&&e==="value")return T(t.children);if(t.name==="input"&&(t.attribs.type==="radio"||t.attribs.type==="checkbox")&&e==="value")return"on"}}function C(t,e,n){n===null?vt(t,e):t.attribs[e]=`${n}`}function oe(t,e){if(typeof t=="object"||e!==void 0){if(typeof e=="function"){if(typeof t!="string")throw new Error("Bad combination of arguments.");return h(this,(n,r)=>{d(n)&&C(n,t,e.call(n,r,n.attribs[t]))})}return h(this,n=>{if(d(n))if(typeof t=="object")for(let r of Object.keys(t)){let i=t[r];C(n,r,i)}else C(n,t,e)})}return arguments.length>1?this:W(this[0],t,this.options.xmlMode)}function _t(t,e,n){return e in t?t[e]:!n&&tt.test(e)?W(t,e,!1)!==void 0:W(t,e,n)}function K(t,e,n,r){e in t?t[e]=n:C(t,e,!r&&tt.test(e)?n?"":null:`${n}`)}function se(t,e){var n;if(typeof t=="string"&&e===void 0){let r=this[0];if(!r||!d(r))return;switch(t){case"style":{let i=this.css(),o=Object.keys(i);for(let s=0;s<o.length;s++)i[s]=o[s];return i.length=o.length,i}case"tagName":case"nodeName":return r.name.toUpperCase();case"href":case"src":{let i=(n=r.attribs)===null||n===void 0?void 0:n[t];return typeof URL<"u"&&(t==="href"&&(r.tagName==="a"||r.tagName==="link")||t==="src"&&(r.tagName==="img"||r.tagName==="iframe"||r.tagName==="audio"||r.tagName==="video"||r.tagName==="source"))&&i!==void 0&&this.options.baseURI?new URL(i,this.options.baseURI).href:i}case"innerText":return ne(r);case"textContent":return re(r);case"outerHTML":return this.clone().wrap("<container />").parent().html();case"innerHTML":return this.html();default:return _t(r,t,this.options.xmlMode)}}if(typeof t=="object"||e!==void 0){if(typeof e=="function"){if(typeof t=="object")throw new TypeError("Bad combination of arguments.");return h(this,(r,i)=>{d(r)&&K(r,t,e.call(r,i,_t(r,t,this.options.xmlMode)),this.options.xmlMode)})}return h(this,r=>{if(d(r))if(typeof t=="object")for(let i of Object.keys(t)){let o=t[i];K(r,i,o,this.options.xmlMode)}else K(r,t,e,this.options.xmlMode)})}}function bt(t,e,n){var r;(r=t.data)!==null&&r!==void 0||(t.data={}),typeof e=="object"?Object.assign(t.data,e):typeof e=="string"&&n!==void 0&&(t.data[e]=n)}function ce(t){for(let e of Object.keys(t.attribs)){if(!e.startsWith(Q))continue;let n=xt(e.slice(Q.length));U.call(t.data,n)||(t.data[n]=At(t.attribs[e]))}return t.data}function ae(t,e){let n=Q+yt(e),r=t.data;if(U.call(r,e))return r[e];if(U.call(t.attribs,n))return r[e]=At(t.attribs[n])}function At(t){if(t==="null")return null;if(t==="true")return!0;if(t==="false")return!1;let e=Number(t);if(t===String(e))return e;if(ie.test(t))try{return JSON.parse(t)}catch{}return t}function fe(t,e){var n;let r=this[0];if(!r||!d(r))return;let i=r;return(n=i.data)!==null&&n!==void 0||(i.data={}),t==null?ce(i):typeof t=="object"||e!==void 0?(h(this,o=>{d(o)&&(typeof t=="object"?bt(o,t):bt(o,t,e))}),this):ae(i,t)}function le(t){let e=arguments.length===0,n=this[0];if(!n||!d(n))return e?void 0:this;switch(n.name){case"textarea":return this.text(t);case"select":{let r=this.find("option:selected");if(!e){if(this.attr("multiple")==null&&typeof t=="object")return this;this.find("option").removeAttr("selected");let i=typeof t=="object"?t:[t];for(let o of i)this.find(`option[value="${o}"]`).attr("selected","");return this}return this.attr("multiple")?r.toArray().map(i=>T(i.children)):r.attr("value")}case"input":case"option":return e?this.attr("value"):this.attr("value",t)}}function vt(t,e){!t.attribs||!U.call(t.attribs,e)||delete t.attribs[e]}function Z(t){return t?t.trim().split(I):[]}function ue(t){let e=Z(t);for(let n of e)h(this,r=>{d(r)&&vt(r,n)});return this}function pe(t){return this.toArray().some(e=>{let n=d(e)&&e.attribs.class,r=-1;if(n&&t.length>0)for(;(r=n.indexOf(t,r+1))>-1;){let i=r+t.length;if((r===0||I.test(n[r-1]))&&(i===n.length||I.test(n[i])))return!0}return!1})}function kt(t){if(typeof t=="function")return h(this,(r,i)=>{if(d(r)){let o=r.attribs.class||"";kt.call([r],t.call(r,i,o))}});if(!t||typeof t!="string")return this;let e=t.split(I),n=this.length;for(let r=0;r<n;r++){let i=this[r];if(!d(i))continue;let o=W(i,"class",!1);if(o){let s=` ${o} `;for(let c of e){let a=`${c} `;s.includes(` ${a}`)||(s+=a)}C(i,"class",s.trim())}else C(i,"class",e.join(" ").trim())}return this}function wt(t){if(typeof t=="function")return h(this,(i,o)=>{d(i)&&wt.call([i],t.call(i,o,i.attribs.class||""))});let e=Z(t),n=e.length,r=arguments.length===0;return h(this,i=>{if(d(i))if(r)i.attribs.class="";else{let o=Z(i.attribs.class),s=!1;for(let c=0;c<n;c++){let a=o.indexOf(e[c]);a>=0&&(o.splice(a,1),s=!0,c--)}s&&(i.attribs.class=o.join(" "))}})}function $t(t,e){if(typeof t=="function")return h(this,(s,c)=>{d(s)&&$t.call([s],t.call(s,c,s.attribs.class||"",e),e)});if(!t||typeof t!="string")return this;let n=t.split(I),r=n.length,i=typeof e=="boolean"?e?1:-1:0,o=this.length;for(let s=0;s<o;s++){let c=this[s];if(!d(c))continue;let a=Z(c.attribs.class);for(let p=0;p<r;p++){let f=a.indexOf(n[p]);i>=0&&f<0?a.push(n[p]):i<=0&&f>=0&&a.splice(f,1)}c.attribs.class=a.join(" ")}return this}var st={};j(st,{_findBySelector:()=>ye,add:()=>Ze,addBack:()=>Ge,children:()=>Te,closest:()=>ve,contents:()=>Ne,each:()=>Oe,end:()=>We,eq:()=>Be,filter:()=>Pe,filterArray:()=>ot,find:()=>xe,first:()=>Ue,get:()=>He,has:()=>Re,index:()=>qe,is:()=>Ce,last:()=>Ie,map:()=>De,next:()=>ke,nextAll:()=>we,nextUntil:()=>$e,not:()=>Me,parent:()=>_e,parents:()=>be,parentsUntil:()=>Ae,prev:()=>Le,prevAll:()=>Se,prevUntil:()=>Ee,siblings:()=>je,slice:()=>Fe,toArray:()=>ze});import{isTag as O,hasChildren as he,isDocument as G}from"domhandler";import*as _ from"cheerio-select";import{getChildren as de,getSiblings as me,nextElementSibling as Lt,prevElementSibling as St,uniqueSort as Y}from"domutils";var ge=/^\s*[+~]/;function xe(t){if(!t)return this._make([]);if(typeof t!="string"){let e=x(t)?t.toArray():[t],n=this.toArray();return this._make(e.filter(r=>n.some(i=>F(i,r))))}return this._findBySelector(t,Number.POSITIVE_INFINITY)}function ye(t,e){var n;let r=this.toArray(),i=ge.test(t)?r:this.children().toArray(),o={context:r,root:(n=this._root)===null||n===void 0?void 0:n[0],xmlMode:this.options.xmlMode,lowerCaseTags:this.options.lowerCaseTags,lowerCaseAttributeNames:this.options.lowerCaseAttributeNames,pseudos:this.options.pseudos,quirksMode:this.options.quirksMode};return this._make(_.select(t,i,o,e))}function nt(t){return function(e,...n){return function(r){var i;let o=t(e,this);return r&&(o=ot(o,r,this.options.xmlMode,(i=this._root)===null||i===void 0?void 0:i[0])),this._make(this.length>1&&o.length>1?n.reduce((s,c)=>c(s),o):o)}}}var B=nt((t,e)=>{let n=[];for(let r=0;r<e.length;r++){let i=t(e[r]);i.length>0&&(n=n.concat(i))}return n}),rt=nt((t,e)=>{let n=[];for(let r=0;r<e.length;r++){let i=t(e[r]);i!==null&&n.push(i)}return n});function it(t,...e){let n=null,r=nt((i,o)=>{let s=[];return h(o,c=>{for(let a;(a=i(c))&&!n?.(a,s.length);c=a)s.push(a)}),s})(t,...e);return function(i,o){n=typeof i=="string"?c=>_.is(c,i,this.options):i?H(i):null;let s=r.call(this,o);return n=null,s}}function M(t){return t.length>1?Array.from(new Set(t)):t}var _e=rt(({parent:t})=>t&&!G(t)?t:null,M),be=B(t=>{let e=[];for(;t.parent&&!G(t.parent);)e.push(t.parent),t=t.parent;return e},Y,t=>t.reverse()),Ae=it(({parent:t})=>t&&!G(t)?t:null,Y,t=>t.reverse());function ve(t){var e;let n=[];if(!t)return this._make(n);let r={xmlMode:this.options.xmlMode,root:(e=this._root)===null||e===void 0?void 0:e[0]},i=typeof t=="string"?o=>_.is(o,t,r):H(t);return h(this,o=>{for(o&&!G(o)&&!O(o)&&(o=o.parent);o&&O(o);){if(i(o,0)){n.includes(o)||n.push(o);break}o=o.parent}}),this._make(n)}var ke=rt(t=>Lt(t)),we=B(t=>{let e=[];for(;t.next;)t=t.next,O(t)&&e.push(t);return e},M),$e=it(t=>Lt(t),M),Le=rt(t=>St(t)),Se=B(t=>{let e=[];for(;t.prev;)t=t.prev,O(t)&&e.push(t);return e},M),Ee=it(t=>St(t),M),je=B(t=>me(t).filter(e=>O(e)&&e!==t),Y),Te=B(t=>de(t).filter(O),M);function Ne(){let t=this.toArray().reduce((e,n)=>he(n)?e.concat(n.children):e,[]);return this._make(t)}function Oe(t){let e=0,n=this.length;for(;e<n&&t.call(this[e],e,this[e])!==!1;)++e;return this}function De(t){let e=[];for(let n=0;n<this.length;n++){let r=this[n],i=t.call(r,n,r);i!=null&&(e=e.concat(i))}return this._make(e)}function H(t){return typeof t=="function"?(e,n)=>t.call(e,n,e):x(t)?e=>Array.prototype.includes.call(t,e):function(e){return t===e}}function Pe(t){var e;return this._make(ot(this.toArray(),t,this.options.xmlMode,(e=this._root)===null||e===void 0?void 0:e[0]))}function ot(t,e,n,r){return typeof e=="string"?_.filter(e,t,{xmlMode:n,root:r}):t.filter(H(e))}function Ce(t){let e=this.toArray();return typeof t=="string"?_.some(e.filter(O),t,this.options):t?e.some(H(t)):!1}function Me(t){let e=this.toArray();if(typeof t=="string"){let n=new Set(_.filter(t,e,this.options));e=e.filter(r=>!n.has(r))}else{let n=H(t);e=e.filter((r,i)=>!n(r,i))}return this._make(e)}function Re(t){return this.filter(typeof t=="string"?`:has(${t})`:(e,n)=>this._make(n).find(t).length>0)}function Ue(){return this.length>1?this._make(this[0]):this}function Ie(){return this.length>0?this._make(this[this.length-1]):this}function Be(t){var e;return t=+t,t===0&&this.length<=1?this:(t<0&&(t=this.length+t),this._make((e=this[t])!==null&&e!==void 0?e:[]))}function He(t){return t==null?this.toArray():this[t<0?this.length+t:t]}function ze(){return Array.prototype.slice.call(this)}function qe(t){let e,n;return t==null?(e=this.parent().children(),n=this[0]):typeof t=="string"?(e=this._make(t),n=this[0]):(e=this,n=x(t)?t[0]:t),Array.prototype.indexOf.call(e,n)}function Fe(t,e){return this._make(Array.prototype.slice.call(this,t,e))}function We(){var t;return(t=this.prevObject)!==null&&t!==void 0?t:this._make([])}function Ze(t,e){let n=this._make(t,e),r=Y([...this.get(),...n.get()]);return this._make(r)}function Ge(t){return this.prevObject?this.add(t?this.prevObject.filter(t):this.prevObject):this}var at={};j(at,{_makeDomArray:()=>en,after:()=>un,append:()=>on,appendTo:()=>nn,before:()=>hn,clone:()=>An,empty:()=>xn,html:()=>yn,insertAfter:()=>pn,insertBefore:()=>dn,prepend:()=>sn,prependTo:()=>rn,remove:()=>mn,replaceWith:()=>gn,text:()=>bn,toString:()=>_n,unwrap:()=>fn,wrap:()=>cn,wrapAll:()=>ln,wrapInner:()=>an});import{isTag as Ve,Text as Ke,hasChildren as A,cloneNode as ct,Document as Qe}from"domhandler";import{removeElement as Ye}from"domutils";import{Document as Xe,isDocument as Je}from"domhandler";function Et(t){return function(n,r,i,o){if(typeof Buffer<"u"&&Buffer.isBuffer(n)&&(n=n.toString()),typeof n=="string")return t(n,r,i,o);let s=n;if(!Array.isArray(s)&&Je(s))return s;let c=new Xe([]);return k(s,c),c}}function k(t,e){let n=Array.isArray(t)?t:[t];e?e.children=n:e=null;for(let r=0;r<n.length;r++){let i=n[r];i.parent&&i.parent.children!==n&&Ye(i),e?(i.prev=n[r-1]||null,i.next=n[r+1]||null):i.prev=i.next=null,i.parent=e}return e}import{removeElement as tn}from"domutils";function en(t,e){if(t==null)return[];if(typeof t=="string")return this._parse(t,this.options,!1,null).children.slice(0);if("length"in t){if(t.length===1)return this._makeDomArray(t[0],e);let n=[];for(let r=0;r<t.length;r++){let i=t[r];if(typeof i=="object"){if(i==null)continue;if(!("length"in i)){n.push(e?ct(i,!0):i);continue}}n.push(...this._makeDomArray(i,e))}return n}return[e?ct(t,!0):t]}function jt(t){return function(...e){let n=this.length-1;return h(this,(r,i)=>{if(!A(r))return;let o=typeof e[0]=="function"?e[0].call(r,i,this._render(r.children)):e,s=this._makeDomArray(o,i<n);t(s,r.children,r)})}}function w(t,e,n,r,i){var o,s;let c=[e,n,...r],a=e===0?null:t[e-1],p=e+n>=t.length?null:t[e+n];for(let f=0;f<r.length;++f){let l=r[f],m=l.parent;if(m){let u=m.children.indexOf(l);u>-1&&(m.children.splice(u,1),i===m&&e>u&&c[0]--)}l.parent=i,l.prev&&(l.prev.next=(o=l.next)!==null&&o!==void 0?o:null),l.next&&(l.next.prev=(s=l.prev)!==null&&s!==void 0?s:null),l.prev=f===0?a:r[f-1],l.next=f===r.length-1?p:r[f+1]}return a&&(a.next=r[0]),p&&(p.prev=r[r.length-1]),t.splice(...c)}function nn(t){return(x(t)?t:this._make(t)).append(this),this}function rn(t){return(x(t)?t:this._make(t)).prepend(this),this}var on=jt((t,e,n)=>{w(e,e.length,0,t,n)}),sn=jt((t,e,n)=>{w(e,0,0,t,n)});function Tt(t){return function(e){let n=this.length-1,r=this.parents().last();for(let i=0;i<this.length;i++){let o=this[i],s=typeof e=="function"?e.call(o,i,o):typeof e=="string"&&!R(e)?r.find(e).clone():e,[c]=this._makeDomArray(s,i<n);if(!c||!A(c))continue;let a=c,p=0;for(;p<a.children.length;){let f=a.children[p];Ve(f)?(a=f,p=0):p++}t(o,a,[c])}return this}}var cn=Tt((t,e,n)=>{let{parent:r}=t;if(!r)return;let i=r.children,o=i.indexOf(t);k([t],e),w(i,o,0,n,r)}),an=Tt((t,e,n)=>{A(t)&&(k(t.children,e),k(n,t))});function fn(t){return this.parent(t).not("body").each((e,n)=>{this._make(n).replaceWith(n.children)}),this}function ln(t){let e=this[0];if(e){let n=this._make(typeof t=="function"?t.call(e,0,e):t).insertBefore(e),r;for(let o=0;o<n.length;o++)n[o].type==="tag"&&(r=n[o]);let i=0;for(;r&&i<r.children.length;){let o=r.children[i];o.type==="tag"?(r=o,i=0):i++}r&&this._make(r).append(this)}return this}function un(...t){let e=this.length-1;return h(this,(n,r)=>{if(!A(n)||!n.parent)return;let i=n.parent.children,o=i.indexOf(n);if(o<0)return;let s=typeof t[0]=="function"?t[0].call(n,r,this._render(n.children)):t,c=this._makeDomArray(s,r<e);w(i,o+1,0,c,n.parent)})}function pn(t){typeof t=="string"&&(t=this._make(t)),this.remove();let e=[];for(let n of this._makeDomArray(t)){let r=this.clone().toArray(),{parent:i}=n;if(!i)continue;let o=i.children,s=o.indexOf(n);s<0||(w(o,s+1,0,r,i),e.push(...r))}return this._make(e)}function hn(...t){let e=this.length-1;return h(this,(n,r)=>{if(!A(n)||!n.parent)return;let i=n.parent.children,o=i.indexOf(n);if(o<0)return;let s=typeof t[0]=="function"?t[0].call(n,r,this._render(n.children)):t,c=this._makeDomArray(s,r<e);w(i,o,0,c,n.parent)})}function dn(t){let e=this._make(t);this.remove();let n=[];return h(e,r=>{let i=this.clone().toArray(),{parent:o}=r;if(!o)return;let s=o.children,c=s.indexOf(r);c<0||(w(s,c,0,i,o),n.push(...i))}),this._make(n)}function mn(t){let e=t?this.filter(t):this;return h(e,n=>{tn(n),n.prev=n.next=n.parent=null}),this}function gn(t){return h(this,(e,n)=>{let{parent:r}=e;if(!r)return;let i=r.children,o=typeof t=="function"?t.call(e,n,e):t,s=this._makeDomArray(o);k(s,null);let c=i.indexOf(e);w(i,c,1,s,r),s.includes(e)||(e.parent=e.prev=e.next=null)})}function xn(){return h(this,t=>{if(A(t)){for(let e of t.children)e.next=e.prev=e.parent=null;t.children.length=0}})}function yn(t){if(t===void 0){let e=this[0];return!e||!A(e)?null:this._render(e.children)}return h(this,e=>{if(!A(e))return;for(let r of e.children)r.next=r.prev=r.parent=null;let n=x(t)?t.toArray():this._parse(`${t}`,this.options,!1,e).children;k(n,e)})}function _n(){return this._render(this)}function bn(t){return t===void 0?T(this):typeof t=="function"?h(this,(e,n)=>this._make(e).text(t.call(e,n,T([e])))):h(this,e=>{if(!A(e))return;for(let r of e.children)r.next=r.prev=r.parent=null;let n=new Ke(`${t}`);k(n,e)})}function An(){let t=Array.prototype.map.call(this.get(),n=>ct(n,!0)),e=new Qe(t);for(let n of t)n.parent=e;return this._make(t)}var ft={};j(ft,{css:()=>vn});import{isTag as Nt}from"domhandler";function vn(t,e){if(t!=null&&e!=null||typeof t=="object"&&!Array.isArray(t))return h(this,(n,r)=>{Nt(n)&&Ot(n,t,e,r)});if(this.length!==0)return Dt(this[0],t)}function Ot(t,e,n,r){if(typeof e=="string"){let i=Dt(t),o=typeof n=="function"?n.call(t,r,i[e]):n;o===""?delete i[e]:o!=null&&(i[e]=o),t.attribs.style=kn(i)}else if(typeof e=="object"){let i=Object.keys(e);for(let o=0;o<i.length;o++){let s=i[o];Ot(t,s,e[s],o)}}}function Dt(t,e){if(!t||!Nt(t))return;let n=wn(t.attribs.style);if(typeof e=="string")return n[e];if(Array.isArray(e)){let r={};for(let i of e)n[i]!=null&&(r[i]=n[i]);return r}return n}function kn(t){return Object.keys(t).reduce((e,n)=>`${e}${e?" ":""}${n}: ${t[n]};`,"")}function wn(t){if(t=(t||"").trim(),!t)return{};let e={},n;for(let r of t.split(";")){let i=r.indexOf(":");if(i<1||i===r.length-1){let o=r.trimEnd();o.length>0&&n!==void 0&&(e[n]+=`;${o}`)}else n=r.slice(0,i).trim(),e[n]=r.slice(i+1).trim()}return e}var lt={};j(lt,{serialize:()=>Sn,serializeArray:()=>En});import{isTag as $n}from"domhandler";var Pt="input,select,textarea,keygen",Ln=/%20/g,Ct=/\r?\n/g;function Sn(){return this.serializeArray().map(n=>`${encodeURIComponent(n.name)}=${encodeURIComponent(n.value)}`).join("&").replace(Ln,"+")}function En(){return this.map((t,e)=>{let n=this._make(e);return $n(e)&&e.name==="form"?n.find(Pt).toArray():n.filter(Pt).toArray()}).filter('[name!=""]:enabled:not(:submit, :button, :image, :reset, :file):matches([checked], :not(:checkbox, :radio))').map((t,e)=>{var n;let r=this._make(e),i=r.attr("name"),o=(n=r.val())!==null&&n!==void 0?n:"";return Array.isArray(o)?o.map(s=>({name:i,value:s.replace(Ct,`\r
`)})):{name:i,value:o.replace(Ct,`\r
`)}}).toArray()}var ut={};j(ut,{extract:()=>Tn});function jn(t){var e;return typeof t=="string"?{selector:t,value:"textContent"}:{selector:t.selector,value:(e=t.value)!==null&&e!==void 0?e:"textContent"}}function Tn(t){let e={};for(let n in t){let r=t[n],i=Array.isArray(r),{selector:o,value:s}=jn(i?r[0]:r),c=typeof s=="function"?s:typeof s=="string"?a=>this._make(a).prop(s):a=>this._make(a).extract(s);if(i)e[n]=this._findBySelector(o,Number.POSITIVE_INFINITY).map((a,p)=>c(p,n,e)).get();else{let a=this._findBySelector(o,1);e[n]=a.length>0?c(a[0],n,e):void 0}}return e}var $=class{constructor(e,n,r){if(this.length=0,this.options=r,this._root=n,e){for(let i=0;i<e.length;i++)this[i]=e[i];this.length=e.length}}};$.prototype.cheerio="[cheerio object]";$.prototype.splice=Array.prototype.splice;$.prototype[Symbol.iterator]=Array.prototype[Symbol.iterator];Object.assign($.prototype,et,st,at,ft,lt,ut);function Mt(t,e){return function n(r,i,o=!0){if(r==null)throw new Error("cheerio.load() expects a string");let s=P(i),c=t(r,s,o,null);class a extends ${_make(l,m){let y=p(l,m);return y.prevObject=this,y}_parse(l,m,y,u){return t(l,m,y,u)}_render(l){return e(l,this.options)}}function p(f,l,m=c,y){if(f&&x(f))return f;let u=P(y,s),L=typeof m=="string"?[t(m,u,!1,null)]:"length"in m?m:[m],g=x(L)?L:new a(L,null,u);if(g._root=g,!f)return new a(void 0,g,u);let D=typeof f=="string"&&R(f)?t(f,u,!1,null).children:Nn(f)?[f]:Array.isArray(f)?f:void 0,v=new a(D,g,u);if(D)return v;if(typeof f!="string")throw new TypeError("Unexpected type of selector");let S=f,E=l?typeof l=="string"?R(l)?new a([t(l,u,!1,null)],g,u):(S=`${l} ${S}`,g):x(l)?l:new a(Array.isArray(l)?l:[l],g,u):g;return E?E.find(S):v}return Object.assign(p,V,{load:n,_root:c,_options:s,fn:a.prototype,prototype:a.prototype}),p}}function Nn(t){return!!t.name||t.type==="root"||t.type==="text"||t.type==="comment"}import{isDocument as On}from"domhandler";import{parse as Dn,parseFragment as Pn,serializeOuter as Cn}from"parse5";import{adapter as Rt}from"parse5-htmlparser2-tree-adapter";function Ut(t,e,n,r){var i;return(i=e.treeAdapter)!==null&&i!==void 0||(e.treeAdapter=Rt),e.scriptingEnabled!==!1&&(e.scriptingEnabled=!0),n?Dn(t,e):Pn(r,t,e)}var Mn={treeAdapter:Rt};function It(t){let e="length"in t?t:[t];for(let r=0;r<e.length;r+=1){let i=e[r];On(i)&&Array.prototype.splice.call(e,r,1,...i.children)}let n="";for(let r=0;r<e.length;r+=1){let i=e[r];n+=Cn(i,Mn)}return n}import Rn from"dom-serializer";import{parseDocument as Un}from"htmlparser2";var In=Et((t,e,n,r)=>e._useHtmlParser2?Un(t,e):Ut(t,e,n,r)),z=Mt(In,(t,e)=>e._useHtmlParser2?Rn(t,e):It(t));import{adapter as Br}from"parse5-htmlparser2-tree-adapter";import*as Bn from"htmlparser2";import{ParserStream as zr}from"parse5-parser-stream";import{decodeBuffer as Fr,DecodeStream as Wr}from"encoding-sniffer";import*as Hn from"undici";import Gr from"whatwg-mimetype";import{Writable as Xr,finished as Jr}from"node:stream";import{spawnSync as X}from"node:child_process";import{mkdir as Fn}from"node:fs/promises";import Wn from"node:os";import Zn from"node:path";import Gn from"node:url";var Bt={name:"soaper-dl",version:"1.0.0",description:"search & download from soaper.tv cli",type:"module",main:"-",scripts:{tsup:"tsup soaper-dl.ts",posttsup:"mv dist/soaper-dl.js dist/soaper-dl && chmod +x dist/soaper-dl",lint:"eslint soaper-dl.ts",test:'echo "Error: no test specified" && exit 1'},author:"fraasi",license:"ISC",dependencies:{cheerio:"^1.0.0"},devDependencies:{"@eslint/js":"^9.13.0","@types/cheerio":"^0.22.35","@types/node":"^22.7.8",eslint:"^9.13.0","eslint-formatter-compact":"^8.40.0",globals:"^15.11.0",tsup:"^8.1.0",typescript:"^5.6.3","typescript-eslint":"^8.11.0"}};var Yn=Zn.basename(Gn.fileURLToPath(import.meta.url)),J=process.argv.slice(2).join(" "),b="https://soaper.tv",q=process.env.SOAPER_DOWNLOAD_PATH||Wn.homedir(),pt=process.env.SOAPER_SUB_LANG||"en",Xn=new Date().getFullYear(),Jn=Bt.version;(J==="-h"||J==="--help")&&(console.info(`
Usage: ${Yn} <SEARCH TERM>
  if no <SEARCH TERM>, fetches  new releases list
  v${Jn}`),process.exit(0));async function Vn(){let t=await fetch(`https://soaper.tv/movielist/year/${Xn}/sort/release`).then(s=>s.text()).then(s=>z(s)),e=[];t("div.thumbnail.text-center").each((s,c)=>{let a=t(c).find(".img-tip.label.label-info").text(),p=t(c).find(".img-right-bottom-tip").text(),f=t(c).find("h5").text().replaceAll(" ","_"),l=t(c).find("h5 > a").attr("href");e.push(`[${a}-${p}] ${f} ${b+l}`)});let r=e.sort((s,c)=>s.split(" ")[0]<c.split(" ")[0]?-1:1).reverse(),o=(await ht(r,"New releases")).replace(/-\d{2}-\d{2}(] )/,"$1");Ft(o)}async function ht(t,e){let n=X(`echo "${t.join(`
`)}" | fzf --header-first --header="${e}" --cycle --with-nth 1,2,3`,{stdio:["inherit","pipe","inherit"],shell:!0,encoding:"utf-8"});return(n.status===null||n.status===130)&&(console.info("[soaper-dl] Canceled"),process.exit(0)),n.stdout.replace(/\n$/,"")}async function Kn(t){let e=`${b}/search.html?keyword=`,n=await fetch(e+t).then(s=>s.text()).then(s=>z(s)),r=n("div.thumbnail.text-center");r.length===0&&(console.info("[soaper-dl] Nothing found, try another search term"),process.exit(0));let i=[];return r.each((s,c)=>{let a=n(c).find(".img-group > div").text(),p=n(c).find("h5").text().replaceAll(" ","_"),f=n(c).find("h5 > a").attr("href");i.push(`[${a}] ${p} ${b+f}`)}),await ht(i,`Search results for '${J}'`)}async function Ht(t,e){let n=t.match(/_(?<pass>.*)\.html/)?.groups?.pass??"";if(!n)throw"[soaper-dl-error] Couldn't get passkey";let r=await fetch(`${b}/home/index/${e}`,{headers:{"content-type":"application/x-www-form-urlencoded; charset=UTF-8",Referer:`${b}${t}`},body:`pass=${n}`,method:"POST"}).then(c=>c.json()),{subs:i,val:o}=r;if(o==="Cannot get video source.")throw"[soaper-dl-error] Cannot get video source.";let s=i?.find(c=>c.name.includes(pt));return{m3u8Link:o,subLink:s?.path?s.path:null}}function zt(t){return t.replace(/[/\\*?<:>|'[\]()]/g,"")}function qt(t){return Number(t)<10?"0"+t:t}async function Ft(t){let[e,n,r]=t.split(" "),i=t.includes("/tv_"),o=i?"GetEInfoAjax":"GetMInfoAjax";if(i){if(i){let s=n.split("_").slice(0,-1).join("_")||"",c=`${q}/${s}`,a=await fetch(r).then(u=>u.text()).then(u=>z(u)),p=[],f=a(".alert-info-ex");for(let u of f){let L=a(u).find("h4").text(),g=/Season(\d{1,2})/.exec(L)?.[1]||"N/A",D=a(u).find("div > a");for(let v of D){let[S,E]=a(v).text().replaceAll(" ","_").split(".");p.push(`[S${qt(g)}E${qt(S)}] ${E} ${b+a(v).attr("href")}`)}}let m=(await ht(p,"Choose episodes with <TAB>")).split(`
`).sort(),y=[];for(let u of m){if(!u)continue;let[L,g,D]=u.split(" "),v=zt(`${s}_${L}_${g}`),{m3u8Link:S,subLink:E}=await Ht(D,o);if(E){let Zt=`curl '${b+E}' --output-dir '${c}' -o ${v}.en.srt`;y.push(Zt)}let Wt=`yt-dlp --quiet '${b+S}' -P ${c} -o ${v}.mp4`;y.push(Wt)}try{await Fn(c,{recursive:!0})&&console.info(`[soaper-dl] Creating folder for series: ${c}`)}catch(u){console.error("[soaper-dl-error] Could not make a folder for series"),u instanceof Error&&console.error(u.message),process.exit(1)}for(let u of y)console.info(`[soaper-dl] Downloading ${c}/${u.split(" ").at(-1)}`),X(u,{stdio:["inherit","inherit","inherit"],shell:!0,encoding:"utf-8"})}}else{let{m3u8Link:s,subLink:c}=await Ht(r,o),a=zt(`${n}_${e}`);if(c){console.info(`[soaper-dl] Downloading ${q}/${a}.${pt}.srt`);let f=`curl ${b+c} --output-dir '${q}' -o ${a}.${pt}.srt`;X(f,{stdio:["inherit","pipe","inherit"],shell:!0,encoding:"utf-8"})}console.info(`[soaper-dl] Downloading ${q}/${a}`);let p=`yt-dlp '${b+s}' -P ${q} -o ${a}.mp4`;X(p,{stdio:["inherit","pipe","inherit"],shell:!0,encoding:"utf-8"})}console.info("[soaper-dl] All done"),process.exit(0)}async function Qn(t){t||Vn();let e=await Kn(t).catch(n=>{console.error("[soaper-dl-error] Search fetch failed"),console.error(n),process.exit(1)});e||process.exit(1),await Ft(e)}Qn(J).catch(t=>{console.error(t),process.exit(1)});
//# sourceMappingURL=soaper-dl.js.map